name: Build Custom App

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Name of the custom app directory under stream-apps-custom/'
        required: true
        type: string
      app_version:
        description: 'Version tag for the release (e.g. 1.0.0)'
        required: false
        default: '1.0.0'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify app directory exists
        run: |
          if [ ! -d "stream-apps-custom/${{ inputs.app_name }}" ]; then
            echo "Error: stream-apps-custom/${{ inputs.app_name }} does not exist"
            exit 1
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build custom app
        run: mvn -pl "stream-apps-custom/${{ inputs.app_name }}" -am clean package -DskipTests=false

      - name: Locate built JAR
        id: jar
        run: |
          jar=$(find "stream-apps-custom/${{ inputs.app_name }}/target" -maxdepth 1 -name "*.jar" -not -name "*-plain.jar" | head -1)
          if [ -z "$jar" ]; then
            echo "Error: No JAR found after build"
            exit 1
          fi
          echo "jar_path=$jar" >> "$GITHUB_OUTPUT"
          echo "jar_name=$(basename $jar)" >> "$GITHUB_OUTPUT"
          echo "Built JAR: $jar"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: custom-${{ inputs.app_name }}-v${{ inputs.app_version }}
          name: "Custom App: ${{ inputs.app_name }} v${{ inputs.app_version }}"
          body: |
            Custom stream app **${{ inputs.app_name }}** built from commit ${{ github.sha }}.

            Triggered by agent via workflow_dispatch.

            **Artifact URL:**
            `https://github.com/${{ github.repository }}/releases/download/custom-${{ inputs.app_name }}-v${{ inputs.app_version }}/${{ steps.jar.outputs.jar_name }}`
          files: ${{ steps.jar.outputs.jar_path }}
          draft: false
          prerelease: false
